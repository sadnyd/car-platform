server:
  port: 8080

spring:
  application:
    name: api-gateway

  cloud:
    gateway:
      metrics:
        enabled: true
      routes:

        - id: car-catalog-actuator-route
          uri: http://localhost:8081
          predicates:
            - Path=/catalog/actuator/**
          filters:
            - StripPrefix=1

        - id: inventory-actuator-route
          uri: http://localhost:8082
          predicates:
            - Path=/inventory/actuator/**
          filters:
            - StripPrefix=1

        - id: order-actuator-route
          uri: http://localhost:8083
          predicates:
            - Path=/orders/actuator/**
          filters:
            - StripPrefix=1

        - id: user-actuator-route
          uri: http://localhost:8084
          predicates:
            - Path=/users/actuator/**
          filters:
            - StripPrefix=1

        - id: catalog-ping-route
          uri: http://localhost:8081
          predicates:
            - Path=/catalog/ping
          filters:
            - StripPrefix=1

        - id: car-catalog-route
          uri: http://localhost:8081
          predicates:
            - Path=/catalog/**
          filters:
            - StripPrefix=0

        - id: inventory-ping-route
          uri: http://localhost:8082
          predicates:
            - Path=/inventory/ping
          filters:
            - StripPrefix=1

        - id: inventory-route
          uri: http://localhost:8082
          predicates:
            - Path=/inventory/**
          filters:
            - StripPrefix=0

        - id: order-ping-route
          uri: http://localhost:8083
          predicates:
            - Path=/orders/ping
          filters:
            - StripPrefix=1

        - id: order-route
          uri: http://localhost:8083
          predicates:
            - Path=/orders/**
          filters:
            - StripPrefix=0

        - id: user-ping-route
          uri: http://localhost:8084
          predicates:
            - Path=/users/ping
          filters:
            - StripPrefix=1

        - id: user-route
          uri: http://localhost:8084
          predicates:
            - Path=/users/**
          filters:
            - StripPrefix=0


# ========== AGGREGATION PATTERN CONFIGURATION ==========
# External Service URLs (for aggregation clients)
external:
  services:
    catalog-url: http://localhost:8081
    inventory-url: http://localhost:8082
    order-url: http://localhost:8083

# Resilience4j Configuration (Timeout & Retry Policy)
resilience4j:
  
  # TIMEOUT CONFIGURATION
  timelimiter:
    instances:
      catalogServiceTimeout:
        timeout-duration: 5s
        cancel-running-future: true
      inventoryServiceTimeout:
        timeout-duration: 3s
        cancel-running-future: true
  
  # RETRY CONFIGURATION
  retry:
    instances:
      catalogServiceRetry:
        max-attempts: 1
        wait-duration: 0ms
        retry-exceptions:
          - java.io.IOException
          - java.net.SocketTimeoutException
      inventoryServiceRetry:
        max-attempts: 3
        wait-duration: 100ms
        retry-exceptions:
          - java.io.IOException
          - java.net.SocketTimeoutException
  
  # CIRCUIT BREAKER CONFIGURATION
  circuitbreaker:
    instances:
      catalogServiceCircuitBreaker:
        sliding-window-size: 10
        failure-rate-threshold: 50
        slow-call-rate-threshold: 50
        slow-call-duration-threshold: 5s
        wait-duration-in-open-state: 30s
        permitted-number-of-calls-in-half-open-state: 5
      inventoryServiceCircuitBreaker:
        sliding-window-size: 10
        failure-rate-threshold: 50
        slow-call-rate-threshold: 50
        slow-call-duration-threshold: 3s
        wait-duration-in-open-state: 30s
        permitted-number-of-calls-in-half-open-state: 5
  bulkhead:
    instances:
      catalogServiceBulkhead:
        max-concurrent-calls: 30
        max-wait-duration: 0ms
      inventoryServiceBulkhead:
        max-concurrent-calls: 40
        max-wait-duration: 0ms

# Logging Configuration (Observability)
logging:
  level:
    root: INFO
    org.springframework.cloud.gateway: INFO
    com.carplatform.gateway: DEBUG
    reactor.netty.http.client: INFO
    org.springframework.web.reactive.function.client: INFO
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} - %msg%n"

# Actuator Configuration (observability)
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,env,loggers,prometheus
  endpoint:
    health:
      show-details: always
      probes:
        enabled: true
      group:
        liveness:
          include: ping
        readiness:
          include: readinessState,diskSpace
  metrics:
    tags:
      application: ${spring.application.name}
    export:
      prometheus:
        enabled: true